<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Leave Portal - Apply for Leave</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <h1 class="text-2xl font-bold text-gray-800">Apply for Leave</h1>
                <div class="flex items-center space-x-4">
                    <a 
                        href="/dashboard.html" 
                        class="text-blue-600 hover:text-blue-800"
                    >
                        Back to Dashboard
                    </a>
                    <button 
                        onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Leave Balance Summary -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Your Leave Balance</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="balanceSummary">
                <!-- Balance will be loaded here -->
            </div>
        </div>

        <!-- Leave Application Form -->
        <div class="bg-white rounded-lg shadow p-8">
            <h2 class="text-xl font-semibold mb-6">Leave Application Form</h2>

            <form id="leaveForm" class="space-y-6" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Start Date -->
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Start Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="startDate" 
                            name="startDate" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- End Date -->
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                            End Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="endDate" 
                            name="endDate" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                </div>

                <!-- Leave Type -->
                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-2">
                        Leave Type <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="leaveType" 
                        name="leaveType" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        onchange="handleLeaveTypeChange()"
                    >
                        <option value="">Select leave type</option>
                        <option value="sick">Sick Leave</option>
                        <option value="casual">Casual Leave</option>
                        <option value="vacation">Vacation Leave</option>
                        <option value="academic">Academic Leave</option>
                        <option value="compOff">Compensatory Off</option>
                    </select>
                    <p id="leaveTypeInfo" class="mt-2 text-sm text-gray-600"></p>
                </div>

                <!-- Half Day Option -->
                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        id="isHalfDay" 
                        name="isHalfDay" 
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    >
                    <label for="isHalfDay" class="ml-2 block text-sm text-gray-700">
                        Half Day Leave
                    </label>
                </div>

                <!-- Document Upload (for Academic Leave) -->
                <div id="documentSection" class="hidden">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                        <div class="flex">
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">
                                    Academic Leave Requirements
                                </h3>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        <li>Must be applied at least 14 days in advance</li>
                                        <li>Supporting documents are required</li>
                                        <li>Maximum 5 documents allowed</li>
                                        <li>File size limit: 5MB per file</li>
                                        <li>Allowed formats: PDF, JPG, PNG, DOC, DOCX</li>
                                        <li>Detailed reason (minimum 50 characters) required</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <label for="documents" class="block text-sm font-medium text-gray-700 mb-2">
                        Supporting Documents <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="file" 
                        id="documents" 
                        name="documents" 
                        multiple
                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        onchange="handleFileSelection()"
                    >
                    <p class="mt-1 text-sm text-gray-600">Upload supporting documents (PDF, JPG, PNG, DOC, DOCX)</p>
                    
                    <!-- File Preview -->
                    <div id="filePreview" class="mt-3 hidden">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h4>
                        <div id="fileList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Reason -->
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for Leave <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="reason" 
                        name="reason" 
                        rows="4" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Please provide a detailed reason for your leave request"
                        oninput="checkReasonLength()"
                    ></textarea>
                    <p id="reasonCounter" class="mt-1 text-sm text-gray-500">0 characters</p>
                </div>

                <!-- Working Days Calculation -->
                <div id="workingDaysInfo" class="bg-blue-50 p-4 rounded-md hidden">
                    <p class="text-sm text-blue-800">
                        Working days: <span id="workingDaysCount" class="font-semibold">0</span> days
                        <span id="balanceWarning" class="block mt-1 text-red-600 hidden"></span>
                    </p>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4">
                    <a 
                        href="/dashboard.html" 
                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition"
                    >
                        Cancel
                    </a>
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                        Submit Application
                    </button>
                </div>
            </form>

            <div id="message" class="mt-4 text-center hidden"></div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let leaveBalance = null;
        let holidays = [];

        // Check if user is logged in and load data
        async function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/';
                return null;
            }
            currentUser = JSON.parse(userStr);
            
            // Load leave balance
            await loadLeaveBalance();
            
            // Load holidays
            await loadHolidays();
            
            return currentUser;
        }

        // Load leave balance
        async function loadLeaveBalance() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/leaves/balance', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    leaveBalance = data.balance;
                    displayBalanceSummary(data.balance);
                }
            } catch (error) {
                console.error('Error loading leave balance:', error);
            }
        }

        // Load holidays
        async function loadHolidays() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/leaves/holidays', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    holidays = data.holidays;
                }
            } catch (error) {
                console.error('Error loading holidays:', error);
            }
        }

        // Display balance summary
        function displayBalanceSummary(balance) {
            const container = document.getElementById('balanceSummary');
            container.innerHTML = '';
            
            const types = [
                { key: 'sick', label: 'Sick', color: 'red' },
                { key: 'casual', label: 'Casual', color: 'blue' },
                { key: 'vacation', label: 'Vacation', color: 'green' },
                { key: 'academic', label: 'Academic', color: 'purple' },
                { key: 'compOff', label: 'Comp Off', color: 'orange' }
            ];
            
            types.forEach(type => {
                const div = document.createElement('div');
                div.className = `text-center p-3 bg-${type.color}-50 rounded`;
                div.innerHTML = `
                    <div class="text-2xl font-bold text-${type.color}-600">${balance[type.key] || 0}</div>
                    <div class="text-sm text-${type.color}-700">${type.label}</div>
                `;
                container.appendChild(div);
            });
        }

        // Handle leave type change
        function handleLeaveTypeChange() {
            const leaveType = document.getElementById('leaveType').value;
            const documentSection = document.getElementById('documentSection');
            const leaveTypeInfo = document.getElementById('leaveTypeInfo');
            const reasonField = document.getElementById('reason');
            
            // Show/hide document section and update requirements
            if (leaveType === 'academic') {
                documentSection.classList.remove('hidden');
                document.getElementById('documents').setAttribute('required', 'required');
                reasonField.setAttribute('minlength', '50');
                reasonField.setAttribute('placeholder', 'Please provide a detailed reason for your academic leave (minimum 50 characters). Include course details, institution name, duration, and how this relates to your professional development.');
            } else {
                documentSection.classList.add('hidden');
                document.getElementById('documents').removeAttribute('required');
                reasonField.removeAttribute('minlength');
                reasonField.setAttribute('placeholder', 'Please provide a detailed reason for your leave request');
                
                // Clear file selection
                document.getElementById('documents').value = '';
                document.getElementById('filePreview').classList.add('hidden');
            }
            
            // Show leave type info
            const infoMessages = {
                sick: 'Can be applied same day before 11:00 AM',
                casual: 'Must be applied 7 days in advance',
                vacation: 'Must be applied 7 days in advance',
                academic: 'Must be applied 14 days in advance. Requires supporting documents and detailed reason.',
                compOff: 'Use your earned compensatory off days'
            };
            
            leaveTypeInfo.textContent = infoMessages[leaveType] || '';
            
            // Recalculate working days if dates are selected
            if (document.getElementById('startDate').value && document.getElementById('endDate').value) {
                calculateWorkingDays();
            }
            
            // Update reason counter
            checkReasonLength();
        }

        // Handle file selection for academic leave
        function handleFileSelection() {
            const files = document.getElementById('documents').files;
            const preview = document.getElementById('filePreview');
            const fileList = document.getElementById('fileList');
            
            if (files.length > 0) {
                preview.classList.remove('hidden');
                fileList.innerHTML = '';
                
                // Validate file count
                if (files.length > 5) {
                    alert('Maximum 5 files allowed. Please select fewer files.');
                    document.getElementById('documents').value = '';
                    preview.classList.add('hidden');
                    return;
                }
                
                Array.from(files).forEach((file, index) => {
                    // Validate file size
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                        document.getElementById('documents').value = '';
                        preview.classList.add('hidden');
                        return;
                    }
                    
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
                    fileDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600">${file.name}</span>
                            <span class="ml-2 text-xs text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                        <span class="text-xs text-green-600">✓</span>
                    `;
                    fileList.appendChild(fileDiv);
                });
            } else {
                preview.classList.add('hidden');
            }
        }

        // Check reason length for academic leave
        function checkReasonLength() {
            const reason = document.getElementById('reason').value;
            const counter = document.getElementById('reasonCounter');
            const leaveType = document.getElementById('leaveType').value;
            
            counter.textContent = `${reason.length} characters`;
            
            if (leaveType === 'academic') {
                if (reason.length < 50) {
                    counter.className = 'mt-1 text-sm text-red-500';
                    counter.textContent = `${reason.length}/50 characters (minimum 50 required for academic leave)`;
                } else {
                    counter.className = 'mt-1 text-sm text-green-600';
                    counter.textContent = `${reason.length} characters ✓`;
                }
            } else {
                counter.className = 'mt-1 text-sm text-gray-500';
                counter.textContent = `${reason.length} characters`;
            }
        }

        // Calculate working days
        function calculateWorkingDays() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const leaveType = document.getElementById('leaveType').value;
            
            if (!startDate || !endDate || !leaveType) return;
            
            let count = 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const day = d.getDay();
                const dateStr = d.toISOString().split('T')[0];
                const isHoliday = holidays.some(h => h.date === dateStr);
                
                if (day !== 0 && day !== 6 && !isHoliday) {
                    count++;
                }
            }
            
            // Adjust for half day
            if (document.getElementById('isHalfDay').checked && count === 1) {
                count = 0.5;
            }
            
            // Display working days
            document.getElementById('workingDaysInfo').classList.remove('hidden');
            document.getElementById('workingDaysCount').textContent = count;
            
            // Check balance and show warning
            const balanceWarning = document.getElementById('balanceWarning');
            if (leaveBalance && leaveType && leaveType !== 'wfh') {
                const available = leaveBalance[leaveType] || 0;
                if (count > available) {
                    const lopDays = count - available;
                    balanceWarning.textContent = `Insufficient balance! ${lopDays} days will be marked as Loss of Pay (LOP)`;
                    balanceWarning.classList.remove('hidden');
                } else {
                    balanceWarning.classList.add('hidden');
                }
            }
        }

        // Set minimum date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').setAttribute('min', today);
            document.getElementById('endDate').setAttribute('min', today);
        });

        // Update end date minimum when start date changes
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').setAttribute('min', this.value);
            calculateWorkingDays();
        });

        // Calculate working days when end date changes
        document.getElementById('endDate').addEventListener('change', calculateWorkingDays);

        // Calculate working days when half day changes
        document.getElementById('isHalfDay').addEventListener('change', calculateWorkingDays);

        // Handle form submission
        document.getElementById('leaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const user = await checkAuth();
            if (!user) return;

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const leaveType = document.getElementById('leaveType').value;
            const reason = document.getElementById('reason').value;

            // Validate academic leave specific requirements
            if (leaveType === 'academic') {
                if (reason.length < 50) {
                    alert('Academic leave requires a detailed reason with at least 50 characters');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }

                const files = document.getElementById('documents').files;
                if (files.length === 0) {
                    alert('Please upload supporting documents for academic leave');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
            }

            // Create FormData for file upload
            const formData = new FormData();
            formData.append('startDate', document.getElementById('startDate').value);
            formData.append('endDate', document.getElementById('endDate').value);
            formData.append('leaveType', leaveType);
            formData.append('reason', reason);
            formData.append('isHalfDay', document.getElementById('isHalfDay').checked);

            // Add documents if it's academic leave
            if (leaveType === 'academic') {
                const files = document.getElementById('documents').files;
                for (let i = 0; i < files.length; i++) {
                    formData.append('documents', files[i]);
                }
            }

            const messageDiv = document.getElementById('message');
            messageDiv.classList.add('hidden');

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/leaves/apply', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                messageDiv.classList.remove('hidden');
                
                if (data.success) {
                    messageDiv.className = 'mt-4 text-center text-green-600 bg-green-50 p-4 rounded-md';
                    messageDiv.textContent = data.message;
                    
                    // Reset form
                    this.reset();
                    document.getElementById('workingDaysInfo').classList.add('hidden');
                    document.getElementById('documentSection').classList.add('hidden');
                    document.getElementById('filePreview').classList.add('hidden');
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 2000);
                } else {
                    messageDiv.className = 'mt-4 text-center text-red-600 bg-red-50 p-4 rounded-md';
                    messageDiv.textContent = data.message;
                }
            } catch (error) {
                messageDiv.classList.remove('hidden');
                messageDiv.className = 'mt-4 text-center text-red-600 bg-red-50 p-4 rounded-md';
                messageDiv.textContent = 'An error occurred. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html> 