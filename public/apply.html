<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Leave Portal - Apply for Leave</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <h1 class="text-2xl font-bold text-gray-800">Apply for Leave</h1>
                <div class="flex items-center space-x-4">
                    <a 
                        href="/dashboard.html" 
                        class="text-blue-600 hover:text-blue-800"
                    >
                        Back to Dashboard
                    </a>
                    <button 
                        onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Leave Balance Summary -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Your Leave Balance</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="balanceSummary">
                <!-- Balance will be loaded here -->
            </div>
        </div>

        <!-- Leave Application Form -->
        <div class="bg-white rounded-lg shadow p-8">
            <h2 class="text-xl font-semibold mb-6">Leave Application Form</h2>

            <form id="leaveForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Start Date -->
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">
                            Start Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="startDate" 
                            name="startDate" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- End Date -->
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">
                            End Date <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="endDate" 
                            name="endDate" 
                            required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                </div>

                <!-- Leave Type -->
                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-2">
                        Leave Type <span class="text-red-500">*</span>
                    </label>
                    <select 
                        id="leaveType" 
                        name="leaveType" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        onchange="handleLeaveTypeChange()"
                    >
                        <option value="">Select leave type</option>
                        <option value="sick">Sick Leave</option>
                        <option value="casual">Casual Leave</option>
                        <option value="vacation">Vacation Leave</option>
                        <option value="academic">Academic Leave</option>
                        <option value="compOff">Compensatory Off</option>
                    </select>
                    <p id="leaveTypeInfo" class="mt-2 text-sm text-gray-600"></p>
                </div>

                <!-- Half Day Option -->
                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        id="isHalfDay" 
                        name="isHalfDay" 
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    >
                    <label for="isHalfDay" class="ml-2 block text-sm text-gray-700">
                        Half Day Leave
                    </label>
                </div>

                <!-- Document Upload (for Academic Leave) -->
                <div id="documentSection" class="hidden">
                    <label for="documents" class="block text-sm font-medium text-gray-700 mb-2">
                        Supporting Documents <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="file" 
                        id="documents" 
                        name="documents" 
                        multiple
                        accept=".pdf,.jpg,.jpeg,.png"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <p class="mt-1 text-sm text-gray-600">Upload supporting documents (PDF, JPG, PNG)</p>
                </div>

                <!-- Reason -->
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for Leave <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="reason" 
                        name="reason" 
                        rows="4" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Please provide a detailed reason for your leave request"
                    ></textarea>
                </div>

                <!-- Working Days Calculation -->
                <div id="workingDaysInfo" class="bg-blue-50 p-4 rounded-md hidden">
                    <p class="text-sm text-blue-800">
                        Working days: <span id="workingDaysCount" class="font-semibold">0</span> days
                        <span id="balanceWarning" class="block mt-1 text-red-600 hidden"></span>
                    </p>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4">
                    <a 
                        href="/dashboard.html" 
                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition"
                    >
                        Cancel
                    </a>
                    <button 
                        type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
                    >
                        Submit Application
                    </button>
                </div>
            </form>

            <div id="message" class="mt-4 text-center hidden"></div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let leaveBalance = null;
        let holidays = [];

        // Check if user is logged in and load data
        async function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/';
                return null;
            }
            currentUser = JSON.parse(userStr);
            
            // Load leave balance
            await loadLeaveBalance();
            
            // Load holidays
            await loadHolidays();
            
            return currentUser;
        }

        // Load leave balance
        async function loadLeaveBalance() {
            try {
                const response = await fetch('/api/leaves/balance');
                const data = await response.json();
                
                if (data.success) {
                    leaveBalance = data.balance;
                    displayBalanceSummary(data.balance);
                }
            } catch (error) {
                console.error('Error loading leave balance:', error);
            }
        }

        // Load holidays
        async function loadHolidays() {
            try {
                const response = await fetch('/api/leaves/holidays');
                const data = await response.json();
                
                if (data.success) {
                    holidays = data.holidays;
                }
            } catch (error) {
                console.error('Error loading holidays:', error);
            }
        }

        // Display balance summary
        function displayBalanceSummary(balance) {
            const container = document.getElementById('balanceSummary');
            container.innerHTML = '';
            
            const types = [
                { key: 'sick', label: 'Sick', color: 'red' },
                { key: 'casual', label: 'Casual', color: 'blue' },
                { key: 'vacation', label: 'Vacation', color: 'green' },
                { key: 'compOff', label: 'Comp Off', color: 'purple' }
            ];
            
            types.forEach(type => {
                const div = document.createElement('div');
                div.className = `text-center p-3 bg-${type.color}-50 rounded`;
                div.innerHTML = `
                    <div class="text-2xl font-bold text-${type.color}-600">${balance[type.key] || 0}</div>
                    <div class="text-sm text-${type.color}-700">${type.label}</div>
                `;
                container.appendChild(div);
            });
        }

        // Handle leave type change
        function handleLeaveTypeChange() {
            const leaveType = document.getElementById('leaveType').value;
            const documentSection = document.getElementById('documentSection');
            const leaveTypeInfo = document.getElementById('leaveTypeInfo');
            
            // Show/hide document section
            if (leaveType === 'academic') {
                documentSection.classList.remove('hidden');
                document.getElementById('documents').setAttribute('required', 'required');
            } else {
                documentSection.classList.add('hidden');
                document.getElementById('documents').removeAttribute('required');
            }
            
            // Show leave type info
            const infoMessages = {
                sick: 'Can be applied same day before 11:00 AM',
                casual: 'Must be applied 7 days in advance',
                vacation: 'Must be applied 7 days in advance',
                academic: 'Requires supporting documents',
                compOff: 'Use your earned compensatory off days'
            };
            
            leaveTypeInfo.textContent = infoMessages[leaveType] || '';
            
            // Recalculate working days if dates are selected
            if (document.getElementById('startDate').value && document.getElementById('endDate').value) {
                calculateWorkingDays();
            }
        }

        // Calculate working days
        function calculateWorkingDays() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const leaveType = document.getElementById('leaveType').value;
            
            if (!startDate || !endDate || !leaveType) return;
            
            let count = 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const day = d.getDay();
                const dateStr = d.toISOString().split('T')[0];
                const isHoliday = holidays.some(h => h.date === dateStr);
                
                if (day !== 0 && day !== 6 && !isHoliday) {
                    count++;
                }
            }
            
            // Adjust for half day
            if (document.getElementById('isHalfDay').checked && count === 1) {
                count = 0.5;
            }
            
            // Display working days
            document.getElementById('workingDaysInfo').classList.remove('hidden');
            document.getElementById('workingDaysCount').textContent = count;
            
            // Check balance and show warning
            const balanceWarning = document.getElementById('balanceWarning');
            if (leaveBalance && leaveType && leaveType !== 'wfh') {
                const available = leaveBalance[leaveType] || 0;
                if (count > available) {
                    const lopDays = count - available;
                    balanceWarning.textContent = `Insufficient balance! ${lopDays} days will be marked as Loss of Pay (LOP)`;
                    balanceWarning.classList.remove('hidden');
                } else {
                    balanceWarning.classList.add('hidden');
                }
            }
        }

        // Set minimum date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').setAttribute('min', today);
            document.getElementById('endDate').setAttribute('min', today);
        });

        // Update end date minimum when start date changes
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').setAttribute('min', this.value);
            calculateWorkingDays();
        });

        // Calculate working days when end date changes
        document.getElementById('endDate').addEventListener('change', calculateWorkingDays);

        // Calculate working days when half day changes
        document.getElementById('isHalfDay').addEventListener('change', calculateWorkingDays);

        // Handle form submission
        document.getElementById('leaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const user = await checkAuth();
            if (!user) return;

            const formData = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                leaveType: document.getElementById('leaveType').value,
                reason: document.getElementById('reason').value,
                isHalfDay: document.getElementById('isHalfDay').checked
            };

            // Handle document upload for academic leave
            if (formData.leaveType === 'academic') {
                const files = document.getElementById('documents').files;
                if (files.length === 0) {
                    alert('Please upload supporting documents for academic leave');
                    return;
                }
                // In a real application, you would upload files to a server
                formData.documents = Array.from(files).map(f => f.name);
            }

            const messageDiv = document.getElementById('message');
            messageDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/leaves/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                messageDiv.classList.remove('hidden');
                
                if (data.success) {
                    messageDiv.className = 'mt-4 text-center text-green-600';
                    messageDiv.textContent = data.message;
                    
                    // Reset form
                    this.reset();
                    document.getElementById('workingDaysInfo').classList.add('hidden');
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 2000);
                } else {
                    messageDiv.className = 'mt-4 text-center text-red-600';
                    messageDiv.textContent = data.message;
                }
            } catch (error) {
                messageDiv.classList.remove('hidden');
                messageDiv.className = 'mt-4 text-center text-red-600';
                messageDiv.textContent = 'An error occurred. Please try again.';
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html> 